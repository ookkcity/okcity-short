<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Redirecting…</title>
  <style>
    body{ font-family:system-ui,-apple-system,"Noto Sans TC",sans-serif; background:#0b1220; color:#e8eefc; margin:0; }
    .wrap{ max-width:720px; margin:40px auto; padding:0 16px; }
    .muted{ color:#aab6d6; }
    a{ color:#6aa9ff; text-decoration:none; }
    code{ background:#111a2e; border:1px solid #243150; padding:2px 6px; border-radius:8px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1 style="font-size:18px; margin:0 0 10px;"></h1>
    <p class="muted" id="msg">別急...你等等</p>
    <p class="muted"><a id="homeLink" href="/">首頁</a></p>
  </div>

  <script>
    // 一定要跟主頁同一支（create/list/update/rename/resolve 都在同一個 GAS）
    const GAS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbyJO5jZQClafYhxal66gLePPXjUg1JaggATJ0Ww3hkOgDqQs8eInlhgX0WkKD0Y9X1s/exec';

    function jsonp(url){
      return new Promise((resolve, reject) => {
        const cb = 'cb_' + Math.random().toString(36).slice(2);
        window[cb] = (data) => {
          try { delete window[cb]; } catch(e){}
          script.remove();
          resolve(data);
        };
        const script = document.createElement('script');
        script.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cb;
        script.onerror = () => reject(new Error('JSONP load failed'));
        document.body.appendChild(script);
      });
    }

    function escapeHtml(s){
      return String(s || "")
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function getBasePath(){
      // 404.html 通常會在：
      // - 根：/404.html
      // - 子路徑：/repo/404.html
      // 我們要取出 "/repo" 這段；若在根就是空字串
      const p = location.pathname;
      if (p.endsWith('/404.html')) return p.replace(/\/404\.html$/, '');
      if (p.endsWith('404.html')) return p.replace(/404\.html$/, '').replace(/\/$/, '');
      return p.replace(/\/$/, '');
    }

    (async () => {
      const msg = document.getElementById('msg');
      const basePath = getBasePath();

      // 首頁連結也要支援子路徑
      const homeUrl = location.origin + (basePath ? (basePath + '/') : '/');
      document.getElementById('homeLink').href = homeUrl;

      // 解析短碼：
      // - 根網域：/abc123        => abc123
      // - 子路徑：/repo/abc123   => abc123
      let codePath = location.pathname;

      if (basePath && codePath.startsWith(basePath + '/')) {
        codePath = codePath.slice((basePath + '/').length);
      } else {
        codePath = codePath.replace(/^\/+/, '');
      }

      const code = codePath.trim();

      // 如果是回到 404.html 本身或空的，回首頁
      if(!code || code.toLowerCase() === '404.html'){
        location.replace(homeUrl);
        return;
      }

      // 避免把 favicon.ico 當成短碼
      if(code.toLowerCase() === 'favicon.ico'){
        msg.textContent = 'Not found';
        return;
      }

      const u = new URL(GAS_ENDPOINT);
      u.searchParams.set('action', 'resolve');
      u.searchParams.set('code', code);

      try{
        const res = await jsonp(u.toString());
        if(res && res.ok && res.url){
          msg.textContent = '轉址中…';
          location.replace(res.url);
        }else{
          msg.innerHTML = '找不到短碼：<code>' + escapeHtml(code) + '</code>';
        }
      }catch(err){
        msg.textContent = '查詢失敗：' + (err && err.message ? err.message : String(err));
      }
    })();
  </script>
</body>
</html>
