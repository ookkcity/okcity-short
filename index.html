<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>s.okcity.tw çŸ­ç¶²å€ç”Ÿæˆå™¨</title>
  <style>
    :root{
      --bg:#0b1220; --card:#111a2e; --text:#e8eefc; --muted:#aab6d6;
      --accent:#6aa9ff; --danger:#ff6a7a; --ok:#4fe3b6; --line:#243150;
    }
    body{ margin:0; font-family:system-ui,-apple-system,"Noto Sans TC",sans-serif; background:linear-gradient(180deg,#070b14, #0b1220); color:var(--text); }
    .wrap{ max-width:980px; margin:0 auto; padding:28px 16px 80px; }
    .title{ display:flex; align-items:flex-end; justify-content:space-between; gap:16px; flex-wrap:wrap; }
    h1{ margin:0; font-size:22px; letter-spacing:.5px; }
    .sub{ color:var(--muted); font-size:13px; }
    .card{ margin-top:16px; background:rgba(17,26,46,.85); border:1px solid var(--line); border-radius:14px; padding:16px; }
    label{ display:block; font-size:13px; color:var(--muted); margin-bottom:6px; }
    input, textarea{
      width:100%; box-sizing:border-box; border-radius:12px; border:1px solid var(--line);
      background:#0b1326; color:var(--text); padding:12px 12px; font-size:15px;
      outline:none;
    }
    input:focus, textarea:focus{ border-color:rgba(106,169,255,.7); box-shadow:0 0 0 3px rgba(106,169,255,.15); }
    .row{ display:grid; grid-template-columns: 1fr auto; gap:12px; align-items:end; }
    .btn{
      border:1px solid rgba(106,169,255,.45);
      background:rgba(106,169,255,.14); color:var(--text);
      padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600;
    }
    .btn:hover{ background:rgba(106,169,255,.22); }
    .btn.secondary{ border-color:rgba(170,182,214,.35); background:rgba(170,182,214,.10); }
    .btn.danger{ border-color:rgba(255,106,122,.45); background:rgba(255,106,122,.12); }
    .msg{ margin-top:10px; font-size:14px; color:var(--muted); }
    .msg.ok{ color:var(--ok); }
    .msg.err{ color:var(--danger); }

    /* login icon */
    .login-fab{
      position:fixed; left:18px; bottom:18px;
      width:46px; height:46px; border-radius:14px;
      border:1px solid var(--line);
      background:rgba(17,26,46,.92);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer; user-select:none;
      box-shadow: 0 10px 24px rgba(0,0,0,.35);
    }
    .login-fab:hover{ transform: translateY(-1px); }
    .login-fab span{ font-size:20px; }
    .badge{
      position:fixed; left:74px; bottom:28px;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--line); background:rgba(17,26,46,.92);
      font-size:12px; color:var(--muted);
    }

    /* table */
    table{ width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:14px; border:1px solid var(--line); }
    thead th{
      background:#0b1326; color:var(--muted); font-size:12px;
      text-align:left; padding:10px 10px; border-bottom:1px solid var(--line);
    }
    tbody td{ padding:10px 10px; border-bottom:1px solid rgba(36,49,80,.55); vertical-align:top; }
    tbody tr:last-child td{ border-bottom:none; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .small{ font-size:12px; color:var(--muted); }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; }
    .pill{ display:inline-block; padding:2px 8px; border:1px solid rgba(170,182,214,.25); border-radius:999px; color:var(--muted); font-size:12px; }
    .hidden{ display:none !important; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">
      <div>
        <h1>çŸ­ç¶²å€ç”Ÿæˆå™¨</h1>
        <div class="sub">é¦–é ï¼šç”¢ç”ŸçŸ­ç¢¼ï¼›çŸ­ç¢¼ç¶²å€ï¼š<span class="mono">https://s.okcity.tw/xxxxxx</span></div>
      </div>
      <div class="pill" id="loginStatePill">æœªç™»å…¥</div>
    </div>

    <div class="card">
      <label>é•·ç¶²å€ï¼ˆéœ€å« https:// æˆ– http://ï¼‰</label>
      <div class="row">
        <input id="longUrl" placeholder="https://example.com/very/long/url" />
        <button class="btn" onclick="createShort()">ç”Ÿæˆ</button>
      </div>
      <div class="msg" id="createMsg"></div>
    </div>

    <div class="card hidden" id="adminCard">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
        <div>
          <div style="font-weight:700;">ç®¡ç†ï¼šæ­·å²ç´€éŒ„</div>
          <div class="small">å¯ç·¨è¼¯ URL / noteï¼›æ›´æ–°æœƒç›´æ¥å¯«å›è©¦ç®—è¡¨ã€‚</div>
        </div>
        <div style="display:flex; gap:10px;">
          <button class="btn secondary" onclick="loadList()">é‡æ–°æ•´ç†</button>
          <button class="btn danger" onclick="logout()">ç™»å‡º</button>
        </div>
      </div>

      <div class="msg" id="listMsg"></div>

      <div style="margin-top:12px; overflow:auto;">
        <table>
          <thead>
            <tr>
              <th style="width:120px;">code</th>
              <th>url</th>
              <th style="width:220px;">note</th>
              <th style="width:220px;">æ™‚é–“</th>
              <th style="width:180px;">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- å·¦ä¸‹è§’ç™»å…¥ icon -->
  <div class="login-fab" onclick="toggleLogin()" title="ç™»å…¥/ç™»å‡º">
    <span>ğŸ”‘</span>
  </div>
  <div class="badge" id="badge">é»å·¦ä¸‹è§’ç™»å…¥</div>

  <script>
    /***************
     * Config
     ***************/
    const GAS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbxhOU1QfoXkqBIas1HezuA6ICKdX4kZBQ9twd4UbkFRWbvcJ-GZGEVcvs9s8bcsX2aYMQ/exec'; // â†æ›æˆä½ çš„
    const ADMIN_PASSWORD = '123'; // å‡ç™»å…¥å¯†ç¢¼

    /***************
     * State
     ***************/
    const storageKey = 'okcity_short_admin_token';
    let adminToken = localStorage.getItem(storageKey) || '';

    function isLoggedIn(){
      return !!adminToken;
    }

    function setUI(){
      document.getElementById('adminCard').classList.toggle('hidden', !isLoggedIn());
      document.getElementById('loginStatePill').textContent = isLoggedIn() ? 'å·²ç™»å…¥' : 'æœªç™»å…¥';
      document.getElementById('badge').textContent = isLoggedIn() ? 'ç®¡ç†æ¨¡å¼' : 'é»å·¦ä¸‹è§’ç™»å…¥';
    }

    /***************
     * JSONP helper
     ***************/
    function jsonp(url){
      return new Promise((resolve, reject) => {
        const cb = 'cb_' + Math.random().toString(36).slice(2);
        window[cb] = (data) => {
          try { delete window[cb]; } catch(e){}
          script.remove();
          resolve(data);
        };
        const script = document.createElement('script');
        script.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cb;
        script.onerror = () => reject(new Error('JSONP load failed'));
        document.body.appendChild(script);
      });
    }

    function shortUrlFromCode(code){
      return location.origin.replace(/\/$/, '') + '/' + code;
    }

    function setMsg(id, text, type){
      const el = document.getElementById(id);
      el.textContent = text || '';
      el.className = 'msg' + (type ? (' ' + type) : '');
    }

    /***************
     * Create
     ***************/
    async function createShort(){
      const longUrl = document.getElementById('longUrl').value.trim();
      setMsg('createMsg', 'è™•ç†ä¸­â€¦', '');

      const u = new URL(GAS_ENDPOINT);
      u.searchParams.set('action', 'create');
      u.searchParams.set('url', longUrl);

      try{
        const res = await jsonp(u.toString());
        if(!res.ok) throw new Error(res.error || 'create failed');

        const su = shortUrlFromCode(res.code);
        setMsg('createMsg', `å®Œæˆï¼š${su}`, 'ok');

        // è‹¥å·²ç™»å…¥ï¼Œé †ä¾¿åˆ·æ–°åˆ—è¡¨
        if(isLoggedIn()){
          loadList();
        }
      }catch(err){
        setMsg('createMsg', 'å¤±æ•—ï¼š' + err.message, 'err');
      }
    }

    /***************
     * Login/Logout
     ***************/
    async function toggleLogin(){
      if(isLoggedIn()){
        logout();
        return;
      }
      const pwd = prompt('è¼¸å…¥å¯†ç¢¼ï¼š');
      if(pwd === null) return;

      if(String(pwd).trim() !== ADMIN_PASSWORD){
        alert('å¯†ç¢¼éŒ¯èª¤');
        return;
      }

      // è¨­ tokenï¼ˆé€™è£¡å°±ç”¨ 123ï¼‰
      adminToken = ADMIN_PASSWORD;
      localStorage.setItem(storageKey, adminToken);
      setUI();
      await loadList();
    }

    function logout(){
      adminToken = '';
      localStorage.removeItem(storageKey);
      setUI();
      setMsg('listMsg', '', '');
      document.getElementById('tbody').innerHTML = '';
    }

    /***************
     * List
     ***************/
    async function loadList(){
      if(!isLoggedIn()) return;

      setMsg('listMsg', 'è¼‰å…¥ä¸­â€¦', '');

      const u = new URL(GAS_ENDPOINT);
      u.searchParams.set('action', 'list');
      u.searchParams.set('token', adminToken);

      try{
        const res = await jsonp(u.toString());
        if(!res.ok) throw new Error(res.error || 'list failed');

        renderTable(res.items || []);
        setMsg('listMsg', `å…± ${res.items.length} ç­†`, 'ok');
      }catch(err){
        setMsg('listMsg', 'è¼‰å…¥å¤±æ•—ï¼š' + err.message, 'err');
      }
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#39;");
    }

    function renderTable(items){
      const tbody = document.getElementById('tbody');
      tbody.innerHTML = '';

      for(const it of items){
        const tr = document.createElement('tr');

        const su = shortUrlFromCode(it.code);

        tr.innerHTML = `
          <td class="mono">
            <div><a href="${escapeHtml(su)}" target="_blank" rel="noopener" style="color:var(--accent); text-decoration:none;">${escapeHtml(it.code)}</a></div>
            <div class="small">â†’ é€£çµ</div>
          </td>

          <td>
            <input data-code="${escapeHtml(it.code)}" class="urlInput" value="${escapeHtml(it.url || '')}" />
            <div class="small mono" style="margin-top:6px; opacity:.9;">${escapeHtml(it.url || '')}</div>
          </td>

          <td>
            <textarea data-code="${escapeHtml(it.code)}" class="noteInput" rows="2" placeholder="å‚™è¨»ï¼ˆå¯é¸ï¼‰">${escapeHtml(it.note || '')}</textarea>
          </td>

          <td class="small">
            <div>å»ºç«‹ï¼š<span class="mono">${escapeHtml((it.createdAt || '').replace('T',' ').replace('Z',''))}</span></div>
            <div>æ›´æ–°ï¼š<span class="mono">${escapeHtml((it.updatedAt || '').replace('T',' ').replace('Z',''))}</span></div>
          </td>

          <td>
            <div class="actions">
              <button class="btn" onclick="saveRow('${escapeHtml(it.code)}')">å„²å­˜</button>
              <button class="btn secondary" onclick="copyText('${escapeHtml(su)}')">è¤‡è£½çŸ­ç¶²å€</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      }
    }

    async function saveRow(code){
      if(!isLoggedIn()) return;

      const urlEl = document.querySelector(`.urlInput[data-code="${CSS.escape(code)}"]`);
      const noteEl = document.querySelector(`.noteInput[data-code="${CSS.escape(code)}"]`);
      const url = (urlEl ? urlEl.value : '').trim();
      const note = noteEl ? noteEl.value : '';

      const u = new URL(GAS_ENDPOINT);
      u.searchParams.set('action', 'update');
      u.searchParams.set('token', adminToken);
      u.searchParams.set('code', code);
      u.searchParams.set('url', url);
      u.searchParams.set('note', note);

      setMsg('listMsg', `æ›´æ–° ${code} ä¸­â€¦`, '');

      try{
        const res = await jsonp(u.toString());
        if(!res.ok) throw new Error(res.error || 'update failed');
        setMsg('listMsg', `å·²æ›´æ–°ï¼š${code}`, 'ok');
        // åˆ·æ–°æ™‚é–“æ¬„ä½ï¼ˆç°¡å–®åšæ³•ï¼šæ•´è¡¨é‡è¼‰ï¼‰
        await loadList();
      }catch(err){
        setMsg('listMsg', `æ›´æ–°å¤±æ•—ï¼š${err.message}`, 'err');
      }
    }

    async function copyText(text){
      try{
        await navigator.clipboard.writeText(text);
        setMsg('createMsg', 'å·²è¤‡è£½ï¼š' + text, 'ok');
      }catch(e){
        // fallback
        prompt('è¤‡è£½é€™æ®µï¼š', text);
      }
    }

    // init
    setUI();
    if(isLoggedIn()){
      loadList();
    }
  </script>
</body>
</html>
