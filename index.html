<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OKCTã„‰çŸ­ç¶²å€ç”Ÿæˆå™¨</title>
  <style>
    :root{
      --bg:#0b1220; --card:#111a2e; --text:#e8eefc; --muted:#aab6d6;
      --accent:#6aa9ff; --danger:#ff6a7a; --ok:#4fe3b6; --line:#243150;
    }
    body{ margin:0; font-family:system-ui,-apple-system,"Noto Sans TC",sans-serif; background:linear-gradient(180deg,#070b14, #0b1220); color:var(--text); }
    .wrap{ max-width:1080px; margin:0 auto; padding:20px 16px 80px; }
    .title{ display:flex; align-items:flex-end; justify-content:space-between; gap:16px; flex-wrap:wrap; margin-bottom: 20px; }
    h1{ margin:0; font-size:20px; letter-spacing:.5px; }
    
    /* ä¿®æ”¹é€™è£¡è®“å‰¯æ¨™é¡Œå°é½Šå³é‚Š */
    .title-header { width: 100%; display: flex; justify-content: space-between; align-items: flex-end; }
    .sub{ color:var(--muted); font-size:12px; }
    
    .card{ margin-top:16px; background:rgba(17,26,46,.85); border:1px solid var(--line); border-radius:14px; padding:16px; }
    label{ display:block; font-size:13px; color:var(--muted); margin-bottom:8px; }
    
    input, textarea{
      width:100%; box-sizing:border-box; border-radius:12px; border:1px solid var(--line);
      background:#0b1326; color:var(--text); padding:12px; font-size:15px;
      outline:none; appearance: none;
    }
    input:focus, textarea:focus{ border-color:rgba(106,169,255,.7); box-shadow:0 0 0 3px rgba(106,169,255,.15); }
    
    .row{ display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:end; }
    
    .btn{
      border:1px solid rgba(106,169,255,.45);
      background:rgba(106,169,255,.14); color:var(--text);
      padding:12px 16px; border-radius:12px; cursor:pointer; font-weight:600; 
      text-decoration:none; display:inline-flex; align-items:center; justify-content:center;
      transition: 0.2s; font-size: 14px; min-width: 80px;
    }
    .btn:hover{ background:rgba(106,169,255,.22); }
    .btn:active{ transform: scale(0.98); }
    .btn.secondary{ border-color:rgba(170,182,214,.35); background:rgba(170,182,214,.10); }
    .btn.danger{ border-color:rgba(255,106,122,.45); background:rgba(255,106,122,.12); }
    
    .msg{ margin-top:10px; font-size:13px; color:var(--muted); min-height: 18px; }
    .msg.ok{ color:var(--ok); }
    .msg.err{ color:var(--danger); }

    /* FAB */
    .login-fab{
      position:fixed; left:18px; bottom:18px;
      width:46px; height:46px; border-radius:14px;
      border:1px solid var(--line);
      background:rgba(17,26,46,.92);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer; user-select:none; z-index: 100;
      box-shadow: 0 10px 24px rgba(0,0,0,.35);
    }
    .badge{
      position:fixed; left:74px; bottom:28px;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--line); background:rgba(17,26,46,.92);
      font-size:12px; color:var(--muted); z-index: 99;
    }

    /* RWD Table */
    table{ width:100%; border-collapse:collapse; overflow:hidden; border-radius:14px; }
    thead{ background:#0b1326; }
    thead th{
      color:var(--muted); font-size:12px;
      text-align:left; padding:12px 10px; border-bottom:1px solid var(--line);
    }
    tbody td{ padding:12px 10px; border-bottom:1px solid rgba(36,49,80,.55); vertical-align:top; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
    .small{ font-size:12px; color:var(--muted); line-height: 1.5; }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; }
    .pill{ display:inline-block; padding:2px 8px; border:1px solid rgba(170,182,214,.25); border-radius:999px; color:var(--muted); font-size:11px; }
    .hidden{ display:none !important; }
    
    .url-cell { display: flex; flex-direction: column; gap: 8px; }

    @media (max-width: 600px) {
      .row { grid-template-columns: 1fr; }
      .row .btn { width: 100%; }
      thead { display: none; }
      table, tbody, tr, td { display: block; width: 100%; box-sizing: border-box; }
      tr { 
        margin-bottom: 16px; 
        border: 1px solid var(--line); 
        border-radius: 14px; 
        background: rgba(255,255,255,0.02);
        padding: 12px;
      }
      td { border: none; padding: 8px 0; }
      td::before {
        content: attr(data-label);
        display: block;
        font-size: 11px;
        color: var(--accent);
        margin-bottom: 4px;
        font-weight: bold;
        text-transform: uppercase;
      }
      .actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
      .actions .btn.danger { grid-column: span 2; }
      .time-info { display: flex; justify-content: space-between; border-top: 1px solid var(--line); padding-top: 8px; margin-top: 4px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">
      <div class="title-header">
        <h1>OKCTã„‰çŸ­ç¶²å€ç”Ÿæˆå™¨</h1>
        <div class="sub"><span class="pill" id="loginStatePill">æ­¤ç¶²ç«™BY å…¸å…¸</span></div>
      </div>
    </div>

    <div class="card">
      <label>åŸç¶²å€ï¼ˆéœ€å« https:// æˆ– http://ï¼‰</label>
      <div class="row">
        <input id="longUrl" placeholder="è²¼ä¸Šç¶²å€" />
        <button class="btn" onclick="createShort()">ç”Ÿæˆ</button>
      </div>
      <div class="msg" id="createMsg"></div>
      <div id="createActions" style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;"></div>
    </div>

    <div class="card hidden" id="adminCard">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; margin-bottom: 15px;">
        <div style="font-weight:700;">ç®¡ç†</div>
        <div style="display:flex; gap:8px;">
          <button class="btn secondary" style="padding: 8px 12px;" onclick="loadList()">é‡æ–°æ•´ç†</button>
          <button class="btn danger" style="padding: 8px 12px;" onclick="logout()">ç™»å‡º</button>
        </div>
      </div>

      <div class="msg" id="listMsg"></div>

      <div style="margin-top:12px;">
        <table id="listTable">
          <thead>
            <tr>
              <th style="width:15%">çŸ­ç¢¼</th>
              <th style="width:50%">ç¶²å€</th>
              <th style="width:15%">ç´€éŒ„</th>
              <th style="width:20%"> </th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="login-fab" onclick="toggleLogin()" title="ç™»å…¥/ç™»å‡º">
    <span>ğŸ”‘</span>
  </div>
  <div class="badge" id="badge">ok._.city</div>

  <script>
    const GAS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbzBFIRbeQrTtZvplIrMdaduZefCireEWnhJoEf4NjUydJOO8oJx4H3MKEGPt2HSpuhe3g/exec';
    const ADMIN_PASSWORD = '123'; 
    const storageKey = 'okcity_short_admin_token';
    let adminToken = localStorage.getItem(storageKey) || '';

    function isLoggedIn(){ return !!adminToken; }

    function setUI(){
      document.getElementById('adminCard').classList.toggle('hidden', !isLoggedIn());
      document.getElementById('loginStatePill').textContent = isLoggedIn() ? 'å·²ç™»å…¥ç®¡ç†æ¨¡å¼' : 'æ­¤ç¶²ç«™BY å…¸å…¸';
      document.getElementById('badge').textContent = isLoggedIn() ? 'ç®¡ç†æ¨¡å¼' : 'ok._.city';
    }

    function jsonp(url){
      return new Promise((resolve, reject) => {
        const cb = 'cb_' + Math.random().toString(36).slice(2);
        window[cb] = (data) => {
          try { delete window[cb]; } catch(e){}
          script.remove();
          resolve(data);
        };
        const script = document.createElement('script');
        script.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cb;
        script.onerror = () => reject(new Error('é€£ç·šè¶…æ™‚'));
        document.body.appendChild(script);
      });
    }

    function shortUrlFromCode(code){
      return location.origin.replace(/\/$/, '') + '/' + code;
    }

    function setMsg(id, text, type){
      const el = document.getElementById(id);
      el.textContent = text || '';
      el.className = 'msg' + (type ? (' ' + type) : '');
    }

    async function createShort(){
      const longUrl = document.getElementById('longUrl').value.trim();
      if(!longUrl) return alert('è«‹è¼¸å…¥ç¶²å€');
      
      setMsg('createMsg', 'æ­£åœ¨ç”Ÿæˆä¸­...', '');
      document.getElementById('createActions').innerHTML = '';

      const u = new URL(GAS_ENDPOINT);
      u.searchParams.set('action', 'create');
      u.searchParams.set('url', longUrl);

      try{
        const res = await jsonp(u.toString());
        if(!res.ok) throw new Error(res.error || 'å¤±æ•—');

        const su = shortUrlFromCode(res.code);
        setMsg('createMsg', `å®Œæˆï¼`, 'ok');
        
        document.getElementById('createActions').innerHTML = `
          <button class="btn secondary" onclick="copyBtnAction(this, '${su}')">è¤‡è£½é€£çµ</button>
          <a class="btn" href="${su}" target="_blank">ç›´æ¥é–‹å•Ÿ</a>
        `;
        if(isLoggedIn()) loadList();
      }catch(err){
        setMsg('createMsg', 'å¤±æ•—ï¼š' + err.message, 'err');
      }
    }

    // çµ±ä¸€çš„è¤‡è£½æŒ‰éˆ•æ–‡å­—åˆ‡æ›è™•ç†
    async function copyBtnAction(btn, text) {
      const originalText = btn.textContent;
      try {
        await navigator.clipboard.writeText(text);
        btn.textContent = 'å·²è¤‡è£½ï¼';
        btn.classList.add('ok');
        setTimeout(() => {
          btn.textContent = originalText;
          btn.classList.remove('ok');
        }, 2000);
      } catch (e) {
        prompt('è«‹è¤‡è£½ï¼š', text);
      }
    }

    async function toggleLogin(){
      if(isLoggedIn()){
        if(confirm('ç¢ºå®šè¦ç™»å‡ºï¼Ÿ')) logout();
        return;
      }
      const pwd = prompt('ç®¡ç†å“¡å¯†ç¢¼ï¼š');
      if(!pwd) return;
      if(pwd.trim() !== ADMIN_PASSWORD){
        alert('å¯†ç¢¼ä¸å°å–”');
        return;
      }
      adminToken = ADMIN_PASSWORD;
      localStorage.setItem(storageKey, adminToken);
      setUI();
      loadList();
    }

    function logout(){
      adminToken = '';
      localStorage.removeItem(storageKey);
      setUI();
      document.getElementById('tbody').innerHTML = '';
    }

    async function loadList(){
      if(!isLoggedIn()) return;
      setMsg('listMsg', 'é‚„åœ¨è·‘æ‹‰...ä½ æ…¢æ…¢ç­‰...', '');

      const u = new URL(GAS_ENDPOINT);
      u.searchParams.set('action', 'list');
      u.searchParams.set('token', adminToken);

      try{
        const res = await jsonp(u.toString());
        if(!res.ok) throw new Error(res.error || 'è®€å–å¤±æ•—');
        renderTable(res.items || []);
        setMsg('listMsg', `å…± ${res.items.length} ç­†`, 'ok');
      }catch(err){
        setMsg('listMsg', 'è®€å–å¤±æ•—ï¼š' + err.message, 'err');
      }
    }

    function escapeHtml(s){
      return String(s || "").replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function renderTable(items){
      const tbody = document.getElementById('tbody');
      tbody.innerHTML = '';

      items.forEach(it => {
        const tr = document.createElement('tr');
        const su = shortUrlFromCode(it.code);

        tr.innerHTML = `
          <td data-label="çŸ­ç¢¼">
            <a href="${escapeHtml(su)}" target="_blank" class="mono" style="color:var(--accent); text-decoration:none; font-weight:bold; font-size:16px;">${escapeHtml(it.code)}</a>
          </td>
          <td data-label="ç¶²å€">
            <div class="url-cell">
              <input data-code="${escapeHtml(it.code)}" class="urlInput" value="${escapeHtml(it.url)}" placeholder="https://" />
              <textarea data-code="${escapeHtml(it.code)}" class="noteInput note-input" rows="2" placeholder="è¼¸å…¥å‚™è¨»å…§å®¹...">${escapeHtml(it.note || '')}</textarea>
            </div>
          </td>
          <td data-label="update">
            <div class="time-info">
              <div class="small">å»ºï¼š<span class="mono">${escapeHtml((it.createdAt || '').split('T')[0])}</span></div>
              <div class="small">æ›´ï¼š<span class="mono">${escapeHtml((it.updatedAt || '').split('T')[0])}</span></div>
            </div>
          </td>
          <td data-label=" ">
            <div class="actions">
              <button class="btn" onclick="saveRow('${escapeHtml(it.code)}')">å„²å­˜</button>
              <button class="btn secondary" onclick="copyBtnAction(this, '${escapeHtml(su)}')">è¤‡è£½</button>
              <button class="btn danger" onclick="deleteRow('${escapeHtml(it.code)}')">åˆªé™¤</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function saveRow(code){
      const url = document.querySelector(`.urlInput[data-code="${CSS.escape(code)}"]`).value.trim();
      const note = document.querySelector(`.noteInput[data-code="${CSS.escape(code)}"]`).value;

      const u = new URL(GAS_ENDPOINT);
      u.searchParams.set('action', 'update');
      u.searchParams.set('token', adminToken);
      u.searchParams.set('code', code);
      u.searchParams.set('url', url);
      u.searchParams.set('note', note);

      setMsg('listMsg', `æ›´æ–° ${code} ä¸­...`, '');
      try{
        const res = await jsonp(u.toString());
        if(!res.ok) throw new Error(res.error);
        setMsg('listMsg', `å·²å„²å­˜`, 'ok');
        loadList();
      }catch(err){ alert('å„²å­˜å¤±æ•—ï¼š' + err.message); }
    }

    async function deleteRow(code){
      if(!confirm(`åˆªé™¤å¾Œä¸å¯æ¢å¾©ï¼Œç¢ºå®šåˆªé™¤ ${code}ï¼Ÿ`)) return;
      const u = new URL(GAS_ENDPOINT);
      u.searchParams.set('action', 'delete');
      u.searchParams.set('token', adminToken);
      u.searchParams.set('code', code);

      try{
        await jsonp(u.toString());
        loadList();
      }catch(err){ alert('åˆªé™¤å¤±æ•—'); }
    }

    setUI();
    if(isLoggedIn()) loadList();
  </script>
</body>
</html>
